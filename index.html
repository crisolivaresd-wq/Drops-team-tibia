<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. REEMPLAZA ESTO CON TUS DATOS DE FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyAda8n-auSFl3j_VUYOtPla4snTDzKk8lU",
  authDomain: "drops-team-tibia.firebaseapp.com",
  projectId: "drops-team-tibia",
  storageBucket: "drops-team-tibia.firebasestorage.app",
  messagingSenderId: "953384004491",
  appId: "1:953384004491:web:1b9d9b4e1f2f9c59d95d8e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const MASTER_PASS = "1234"; // Tu contraseña para borrar/editar

    // --- LOGICA DE BASE DE DATOS (Exportada a window para que el HTML la vea) ---

    window.addPlayer = async () => {
        const name = document.getElementById('newPlayerName').value.trim();
        if (name) { 
            await addDoc(collection(db, "players"), { name }); 
            document.getElementById('newPlayerName').value = ''; 
        }
    };

    window.editPlayer = async (id, currentName) => {
        const newName = prompt("Corregir nombre para:", currentName);
        if(newName && newName !== currentName) {
            if(prompt("Senha de Admin:") === MASTER_PASS) {
                await updateDoc(doc(db, "players", id), { name: newName });
            } else { alert("Senha incorreta."); }
        }
    };

    window.removePlayer = async (id) => {
        if(confirm("Tem certeza?") && prompt("Senha de Admin:") === MASTER_PASS) {
            await deleteDoc(doc(db, "players", id));
        }
    };

    window.registerDrop = async () => {
        const item = document.getElementById('itemInput').value.trim();
        const selPlayers = Array.from(document.querySelectorAll('#formPlayerList input:checked')).map(cb => cb.value);

        if (!item) return alert("Digite o nome do item!");
        if (selPlayers.length === 0) return alert("Selecione os participantes!");

        await addDoc(collection(db, "drops"), {
            item: item,
            players: selPlayers,
            dropDate: new Date().toLocaleDateString('pt-BR'),
            timestamp: Date.now(),
            sold: false,
            price: 0
        });

        document.getElementById('itemInput').value = '';
        document.querySelectorAll('#formPlayerList input:checked').forEach(cb => cb.checked = false);
    };

    window.markAsSold = async (id) => {
        const val = prompt("Valor da venda em KKs (ex: 150):");
        if (val && !isNaN(val)) {
            await updateDoc(doc(db, "drops", id), { 
                sold: true, 
                price: Number(val),
                saleDate: new Date().toLocaleDateString('pt-BR'),
                saleTimestamp: Date.now()
            });
        }
    };

    window.deleteDrop = async (id) => {
        if(prompt("Senha de Admin:") === MASTER_PASS) await deleteDoc(doc(db, "drops", id));
    };

    // --- ESCUCHA DE DATOS EN TIEMPO REAL ---
    
    onSnapshot(collection(db, "players"), (snapshot) => {
        const players = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
        window.renderPlayers(players);
    });

    onSnapshot(query(collection(db, "drops"), orderBy("timestamp", "desc")), (snapshot) => {
        const allDrops = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        window.processAndRenderDrops(allDrops);
    });

    // --- FUNCIONES VISUALES (Dentro del módulo para que usen la lógica anterior) ---

    window.copyTransfer = (text, btnId) => {
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.getElementById(btnId);
            btn.innerHTML = 'COPIADO';
            btn.classList.add('text-green-400');
            setTimeout(() => { 
                btn.innerHTML = 'COPY'; 
                btn.classList.remove('text-green-400');
            }, 1500);
        });
    };

    window.renderPlayers = (players) => {
        const formList = document.getElementById('formPlayerList');
        const masterList = document.getElementById('masterPlayerList');
        
        formList.innerHTML = players.map(p => `
            <label class="flex items-center gap-3 p-2 hover:bg-neutral-800 rounded cursor-pointer transition-colors group">
                <input type="checkbox" value="${p.name}" class="w-4 h-4 rounded text-yellow-600 bg-black border-neutral-600 focus:ring-yellow-500 focus:ring-offset-0">
                <span class="text-xs font-medium text-neutral-300 group-hover:text-white">${p.name}</span>
            </label>
        `).join('');

        masterList.innerHTML = players.map(p => `
            <div class="flex justify-between items-center bg-black p-3 rounded border border-neutral-800 hover:border-neutral-600 transition-colors">
                <span class="text-sm font-bold text-white">${p.name}</span>
                <div class="flex gap-2">
                    <button onclick="editPlayer('${p.id}', '${p.name}')" class="text-neutral-500 hover:text-yellow-500 px-2 py-1">✎</button>
                    <button onclick="removePlayer('${p.id}')" class="text-neutral-500 hover:text-red-500 px-2 py-1">✕</button>
                </div>
            </div>
        `).join('');
    };

    window.processAndRenderDrops = (allDrops) => {
        const pendingList = document.getElementById('pendingList');
        const soldList = document.getElementById('soldList');
        pendingList.innerHTML = ''; 
        soldList.innerHTML = '';

        const pending = allDrops.filter(d => !d.sold);
        const sold = allDrops.filter(d => d.sold).sort((a, b) => (b.saleTimestamp || 0) - (a.saleTimestamp || 0));

        if(pending.length === 0) pendingList.innerHTML = '<div class="text-neutral-600 text-center py-4 italic">Nenhum drop pendente.</div>';
        pending.forEach(drop => renderRow(drop, pendingList, false));

        if(sold.length === 0) soldList.innerHTML = '<div class="text-neutral-600 text-center py-4 italic">Histórico vazio.</div>';
        sold.forEach(drop => renderRow(drop, soldList, true));
    };

    function renderRow(drop, container, isSold) {
        const shareKk = isSold ? (drop.price / drop.players.length).toFixed(2) : 0;
        const shareGold = isSold ? Math.floor((drop.price * 1000000) / drop.players.length) : 0;
        const displayDate = isSold && drop.saleDate ? `Vendido: ${drop.saleDate}` : `Drop: ${drop.dropDate}`;

        const html = `
        <div class="bg-neutral-900 border border-neutral-800 hover:border-neutral-600 transition-colors rounded group animate-slide mb-1">
            <div class="grid grid-cols-12 gap-2 p-4 items-center">
                <div class="col-span-4 md:col-span-3">
                    <div class="text-yellow-500 font-bold text-sm uppercase truncate">${drop.item}</div>
                    <div class="text-[10px] text-neutral-500 font-mono mt-1">${displayDate}</div>
                </div>
                <div class="col-span-4 md:col-span-5 flex flex-wrap gap-1">
                    ${drop.players.map(p => `<span class="px-2 py-0.5 bg-black border border-neutral-700 rounded text-[10px] text-neutral-300">${p}</span>`).join('')}
                </div>
                <div class="col-span-4 md:col-span-4 flex flex-col items-end gap-2">
                    ${!isSold ? `
                        <button onclick="markAsSold('${drop.id}')" class="bg-yellow-600/10 hover:bg-yellow-600 hover:text-black text-yellow-500 border border-yellow-600/50 px-3 py-1.5 rounded text-[10px] font-bold uppercase w-full md:w-auto">$ Vender</button>
                        <button onclick="deleteDrop('${drop.id}')" class="text-[10px] text-neutral-600 hover:text-red-500 underline">excluir</button>
                    ` : `
                        <div class="text-right">
                            <div class="text-green-400 font-bold text-sm">${drop.price}kk</div>
                            <div class="text-[10px] text-neutral-500">Share: <span class="text-neutral-300">${shareKk}kk</span></div>
                        </div>
                    `}
                </div>
            </div>
            ${isSold ? `
            <div class="border-t border-neutral-800 bg-black/30 p-2 hidden group-hover:block transition-all">
                <div class="grid grid-cols-1 gap-1">
                     ${drop.players.map((p, idx) => {
                        const cmd = `transfer ${shareGold} to ${p}`;
                        const btnId = `btn-${drop.id}-${idx}`;
                        return `
                        <div class="flex justify-between items-center bg-black px-3 py-1 rounded border border-neutral-800">
                            <code class="text-[10px] text-neutral-400 font-mono truncate select-all">${cmd}</code>
                            <button id="${btnId}" onclick="copyTransfer('${cmd}', '${btnId}')" class="text-[9px] font-bold text-yellow-600 hover:text-white uppercase ml-2">COPY</button>
                        </div>`;
                     }).join('')}
                </div>
            </div>
            ` : ''}
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    window.switchTab = (type) => {
        const pList = document.getElementById('pendingList');
        const sList = document.getElementById('soldList');
        const pTab = document.getElementById('tabPending');
        const sTab = document.getElementById('tabSold');
        if (type === 'pending') {
            pList.classList.remove('hidden'); sList.classList.add('hidden');
            pTab.classList.add('border-yellow-500', 'text-white', 'bg-neutral-900/50');
            pTab.classList.remove('border-transparent', 'text-neutral-500');
            sTab.classList.add('border-transparent', 'text-neutral-500');
            sTab.classList.remove('border-yellow-500', 'text-white', 'bg-neutral-900/50');
        } else {
            sList.classList.remove('hidden'); pList.classList.add('hidden');
            sTab.classList.add('border-yellow-500', 'text-white', 'bg-neutral-900/50');
            sTab.classList.remove('border-transparent', 'text-neutral-500');
            pTab.classList.add('border-transparent', 'text-neutral-500');
            pTab.classList.remove('border-yellow-500', 'text-white', 'bg-neutral-900/50');
        }
    };
</script>